<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NIPALS optimization notes â€¢ nipals</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NIPALS optimization notes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nipals</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/empca_notes.html">EMPCA notes</a></li>
    <li><a class="dropdown-item" href="../articles/nipals_algorithm.html">The NIPALS algorithm</a></li>
    <li><a class="dropdown-item" href="../articles/nipals_comparisons.html">Comparing results and performance of NIPALS functions in R</a></li>
    <li><a class="dropdown-item" href="../articles/nipals_optimization.html">NIPALS optimization notes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/kwstat/nipals/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>NIPALS optimization notes</h1>
                        <h4 data-toc-skip class="author">Kevin
Wright</h4>
            
            <h4 data-toc-skip class="date">2017-10-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kwstat/nipals/blob/main/vignettes/nipals_optimization.Rmd" class="external-link"><code>vignettes/nipals_optimization.Rmd</code></a></small>
      <div class="d-none name"><code>nipals_optimization.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>These are some notes to document some of the optimization process for
the <code>nipals</code> function. As such, it is not complete and the R
code chunks <em>cannot be re-run</em>.</p>
<p>Optimizing performance is a skill that requires a good understanding
of how functions manage memory and calculations, but also involves a
fair bit of trial and error. For example, code that is optimal for small
data may not be optimal for large data. There can also be a trade-off
between code that is optimal and code that is readable. Our view leans
heavily toward the philosophy that programmer time is more expensive
than processor time, so that code should be written for humans.</p>
</div>
<div class="section level2">
<h2 id="general-computational-performance-tips">General computational performance tips<a class="anchor" aria-label="anchor" href="#general-computational-performance-tips"></a>
</h2>
<p>In this section <code>x</code> and <code>y</code> are matrices and
<code>v</code> is a vector.</p>
<ol style="list-style-type: decimal">
<li><p>When possible, avoid looping over the columns of a matrix.
Instead, use <code>apply</code> and similar functions.</p></li>
<li><p>Do not use <code>cbind</code> (or <code>rbind</code>) to assemble
results into a matrix. Instead, initialize a full matrix of NA values
and insert the results into the appropriate column of the
matrix.</p></li>
<li><p>Use <code>x*x</code> instead of <code>x^2</code>. (Not true, R
does this automatically).</p></li>
<li><p>Use <code>sqrt(x)</code> instead of <code>x^0.5</code>.</p></li>
<li><p>Use <code>crossprod(x,y)</code> instead of
<code>t(x) %*% y</code>, since the latter has to transpose first and
then multiply.</p></li>
<li><p>Use <code>crossprod(v)</code> instead of <code>sum(v*v)</code> if
<code>v</code> has a lot more than a million numbers or if the result
could have numeric overflow.</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e8</span><span class="op">)</span> <span class="co"># 100 million</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   0.24    0.00    0.23 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">*</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   0.24    0.17    0.40 </span></span>
<span></span>
<span><span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e9</span><span class="op">)</span> <span class="co"># 1000 million</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   2.99    0.72   19.20 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">*</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   3.25   45.71  141.76 </span></span>
<span></span>
<span><span class="va">v</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1e6</span> <span class="co"># 1 million</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#      0       0       0 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">v</span><span class="op">*</span><span class="va">v</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#      0       0       0 </span></span>
<span><span class="co"># Warning message:</span></span>
<span><span class="co"># In k * k : NAs produced by integer overflow</span></span></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Use <code>colSums(x*x)</code> instead of
<code>diag(crossprod(x))</code> if <code>x</code> is much wider than
1000 columns.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">10</span>, ncol<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#      0       0       0 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   0.83    0.14    0.97 </span></span></code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Avoid making copies of data structures, and avoid repeating
calculations.</li>
</ol>
</div>
<div class="section level2">
<h2 id="calculating-scores-t-xppp">Calculating scores t = Xp/pâ€™p<a class="anchor" aria-label="anchor" href="#calculating-scores-t-xppp"></a>
</h2>
<p>Part of the NIPALS algorithm involves iterating between calculating
the loadings <span class="math inline">$\bf p$</span> and the scores
<span class="math inline">$\bf t$</span>. This section shows some of the
ideas that were tried to increase the performance of the calculation of
the <span class="math inline">$\bf t$</span> vector.</p>
<p>For testing purposes, a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>Ã—</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">100 \times 100</annotation></semantics></math>
matrix is big enough so that tweaks to the code will show differences in
performance time, but small enough so that each call of the function
does not require a lot of waiting. A missing value is inserted to force
the function to use the method needed for missing data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">Bbig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">Bbig2</span> <span class="op">&lt;-</span> <span class="va">Bbig</span></span>
<span><span class="va">Bbig2</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>For the optimizing process, we use code taken from
<code>mixOmics::nipals</code> since it avoids <code>for</code> loops
over the columns of <span class="math inline">$\bf X$</span>, and should
have better performance than <code>ade4::nipals</code> or
<code>plsdepot::nipals</code>.</p>
<p>The timings are the median of 3 runs. The timings in this section
were recorded before the Gram-Schmidt orthogonalization step was
added.</p>
<div class="section level4">
<h4 id="version-1">Version 1<a class="anchor" aria-label="anchor" href="#version-1"></a>
</h4>
<p>This is the version taken from the <code>mixOmics</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">th</span> <span class="op">=</span> <span class="va">x0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">ph</span></span>
<span><span class="va">P</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">ph</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="va">nr.ones</span> <span class="co"># ph in each column, nr.ones is a vector of 1</span></span>
<span><span class="va">P</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x.miss</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">ph.cross</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span></span>
<span><span class="va">th</span> <span class="op">=</span> <span class="va">th</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">ph.cross</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#  10.76    0.00   10.78 </span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="version-2">Version 2<a class="anchor" aria-label="anchor" href="#version-2"></a>
</h4>
<p>Thereâ€™s no need to store the <code>ph.cross</code> object, and the
<code>diag(crossprod())</code> is needlessly expensive since we only
need the diagonal elements. This is an easy change and has a big
reward.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">th</span> <span class="op">=</span> <span class="va">x0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">ph</span></span>
<span><span class="va">P</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">ph</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="va">nr.ones</span> <span class="co"># ph in each column</span></span>
<span><span class="va">P</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x.miss</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">th</span> <span class="op">=</span> <span class="va">th</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">P</span><span class="op">*</span><span class="va">P</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#    4.4     0.0     4.4</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">res0</span>, <span class="va">res</span><span class="op">)</span></span>
<span><span class="co"># TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="version-3">Version 3<a class="anchor" aria-label="anchor" href="#version-3"></a>
</h4>
<p>Most of the columns of <code>P</code> are the same, so the
element-wise multiplication <code>P*P</code> is repeating a lot of the
same multiplications in the different columns. Better to square the
numbers in one column, then put those into all columns. Also, thereâ€™s no
need to calculate <code>th</code> in two steps.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">P2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">ph</span><span class="op">*</span><span class="va">ph</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="va">nr.ones</span> <span class="co"># ph in each column</span></span>
<span><span class="va">P2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x.miss</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">th</span> <span class="op">=</span> <span class="va">x0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">ph</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">P2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#      4       0       4 </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">res0</span>, <span class="va">res</span><span class="op">)</span></span>
<span><span class="co"># TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="version-4">Version 4<a class="anchor" aria-label="anchor" href="#version-4"></a>
</h4>
<p>The first line of code is squaring the elements of <code>ph</code>,
then outer-multiplying by a vector of 1s to insert these into each
column of <code>P2</code>. It makes sense algebraically, but we can
avoid the multiplications and just build the matrix <code>P2</code> by
recycling the first column.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">P2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">ph</span><span class="op">*</span><span class="va">ph</span>, nrow<span class="op">=</span><span class="va">nc</span>, ncol<span class="op">=</span><span class="va">nr</span><span class="op">)</span></span>
<span><span class="va">P2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x.miss</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">th</span> <span class="op">=</span> <span class="va">x0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">ph</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">P2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   3.38    0.00    3.41 </span></span>
<span>   </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">res0</span>, <span class="va">res</span><span class="op">)</span></span>
<span><span class="co"># TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="comments">Comments<a class="anchor" aria-label="anchor" href="#comments"></a>
</h4>
<p>Although this look like an easy optimization, there were numerous
other (failed) versions, and each version often required fiddling with
the syntax to make sure the right results were calculated. For example,
what happens if <code>ph</code> is a vector (not a matrix) and is put
into a matrix operation? Not always what you might expect.</p>
<p>The optimizations described above reduced the user time from 10.76
seconds to 3.38 seconds.</p>
<p>The total effect of all optimizations in the algorithm reduced the
user time for the <code>nipals</code> function from 19.20 seconds to
3.38 seconds in this example.</p>
</div>
</div>
<div class="section level2">
<h2 id="calculating-pp-and-tt">Calculating PPâ€™ and TTâ€™<a class="anchor" aria-label="anchor" href="#calculating-pp-and-tt"></a>
</h2>
<p>In the Gram-Schmidt orthogonalization part of the algorithm, it is
necessary to calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>h</mi></msub><msub><mi>P</mi><mi>h</mi></msub><mi>â€²</mi></mrow><annotation encoding="application/x-tex">P_h P_h'</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mi>h</mi></msub><annotation encoding="application/x-tex">P_h</annotation></semantics></math>
is a matrix of the first
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>h</mi><annotation encoding="application/x-tex">h</annotation></semantics></math>
columns of the loadings matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>.
It is not necessary to re-calculate the entire
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>h</mi></msub><msub><mi>P</mi><mi>h</mi></msub><mi>â€²</mi></mrow><annotation encoding="application/x-tex">P_h P_h'</annotation></semantics></math>
product for each Principal Component, but only to update the product
<span class="math inline">$\bf P_h P_h' = P_{h-1} P_{h-1}' + p_h
p_h'$</span>. Hereâ€™s a numerical illustration:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">P</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">PPp</span> <span class="op">=</span> <span class="va">P</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">PPp</span>,</span>
<span>          <span class="va">P</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">1</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="va">P</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">2</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="va">P</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">3</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co"># TRUE</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">PPp</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">P</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co"># TRUE</span></span>
<span></span>
<span><span class="co"># multiply by a  vector</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span> <span class="va">PPp</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">PPp</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co"># TRUE</span></span></code></pre></div>
<p>Using the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>Ã—</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">100 \times 100</annotation></semantics></math>
matrix example, the Gram-Schmidt method adds only a modest increase in
time.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span>, gramschmidt<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   3.68    0.02    3.70 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nipals.html">nipals</a></span><span class="op">(</span><span class="va">Bbig2</span>, ncomp<span class="op">=</span><span class="fl">100</span>, gramschmidt<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#   user  system elapsed </span></span>
<span><span class="co">#   4.29    0.03    4.37 </span></span></code></pre></div>
<div class="section level4">
<h4 id="r-vs-c-comment">R vs C comment<a class="anchor" aria-label="anchor" href="#r-vs-c-comment"></a>
</h4>
<p>The <code><a href="../reference/nipals.html">nipals()</a></code> function makes heavy use of the
<code><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod()</a></code> and <code><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod()</a></code> functions, which
are already extensively optimized. Non-optimized coding of the NIPALS
algorithm in C would probably be <em>less</em> efficient than the R
version used in this package.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Wright.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
