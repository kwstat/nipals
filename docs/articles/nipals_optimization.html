<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NIPALS optimization notes • nipals</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NIPALS optimization notes">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nipals</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/empca_notes.html">EMPCA notes</a>
    </li>
    <li>
      <a href="../articles/nipals_algorithm.html">The NIPALS algorithm</a>
    </li>
    <li>
      <a href="../articles/nipals_comparisons.html">Comparing results and performance of NIPALS functions in R</a>
    </li>
    <li>
      <a href="../articles/nipals_optimization.html">NIPALS optimization notes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>NIPALS optimization notes</h1>
                        <h4 class="author">Kevin Wright</h4>
            
            <h4 class="date">2017-10-25</h4>
      
      
      <div class="hidden name"><code>nipals_optimization.Rmd</code></div>

    </div>

    
    
<div id="abstract" class="section level1">
<h1 class="hasAnchor">
<a href="#abstract" class="anchor"></a>Abstract</h1>
<p>These are some notes to document some of the optimization process for the <code>nipals</code> function. As such, it is not complete and the R code chunks <em>cannot be re-run</em>.</p>
<p>Optimizing performance is a skill that requires a good understanding of how functions manage memory and calculations, but also involves a fair bit of trial and error. For example, code that is optimal for small data may not be optimal for large data. There can also be a trade-off between code that is optimal and code that is readable. Our view leans heavily toward the philosophy that programmer time is more expensive than processor time, so that code should be written for humans.</p>
</div>
<div id="general-computational-performance-tips" class="section level1">
<h1 class="hasAnchor">
<a href="#general-computational-performance-tips" class="anchor"></a>General computational performance tips</h1>
<p>In this section <code>x</code> and <code>y</code> are matrices and <code>v</code> is a vector.</p>
<ol style="list-style-type: decimal">
<li><p>When possible, avoid looping over the columns of a matrix. Instead, use <code>apply</code> and similar functions.</p></li>
<li><p>Do not use <code>cbind</code> (or <code>rbind</code>) to assemble results into a matrix. Instead, initialize a full matrix of NA values and insert the results into the appropriate column of the matrix.</p></li>
<li><p>Use <code>x*x</code> instead of <code>x^2</code>.</p></li>
<li><p>Use <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt(x)</a></code> instead of <code>x^0.5</code>.</p></li>
<li><p>Use <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod(x,y)</a></code> instead of <code>t(x) %*% y</code>, since the latter has to transpose first and then multiply.</p></li>
<li><p>Use <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod(v)</a></code> instead of <code><a href="https://rdrr.io/r/base/sum.html">sum(v*v)</a></code> if <code>v</code> has a lot more than a million numbers or if the result could have numeric overflow.</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">v =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1e8</span>) <span class="co"># 100 million</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(v))</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#   0.24    0.00    0.23 </span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(v<span class="op">*</span>v))</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#   0.24    0.17    0.40 </span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9">v =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1e9</span>) <span class="co"># 1000 million</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(v))</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co">#   2.99    0.72   19.20 </span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(v<span class="op">*</span>v))</a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">#   3.25   45.71  141.76 </span></a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17">v =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="fl">1e6</span> <span class="co"># 1 million</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(v))</a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="co">#      0       0       0 </span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(v<span class="op">*</span>v))</a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="co">#      0       0       0 </span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="co"># Warning message:</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co"># In k * k : NAs produced by integer overflow</span></a></code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Use <code><a href="https://rdrr.io/r/base/colSums.html">colSums(x*x)</a></code> instead of <code><a href="https://rdrr.io/r/base/diag.html">diag(crossprod(x))</a></code> if <code>x</code> is much wider than 1000 columns.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">x =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">10000</span>), <span class="dt">nrow=</span><span class="dv">10</span>, <span class="dt">ncol=</span><span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(x<span class="op">*</span>x))</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#      0       0       0 </span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(x))</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#   0.83    0.14    0.97 </span></a></code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Avoid making copies of data structures, and avoid repeating calculations.</li>
</ol>
</div>
<div id="calculating-scores-t-xppp" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-scores-t-xppp" class="anchor"></a>Calculating scores t = Xp/p’p</h1>
<p>Part of the NIPALS algorithm involves iterating between calculating the loadings <span class="math inline">\(\bf p\)</span> and the scores <span class="math inline">\(\bf t\)</span>. This section shows some of the ideas that were tried to increase the performance of the calculation of the <span class="math inline">\(\bf t\)</span> vector.</p>
<p>For testing purposes, a <span class="math inline">\(100 \times 100\)</span> matrix is big enough so that tweaks to the code will show differences in performance time, but small enough so that each call of the function does not require a lot of waiting. A missing value is inserted to force the function to use the method needed for missing data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb3-2" title="2">Bbig &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">100</span><span class="op">*</span><span class="dv">100</span>), <span class="dt">nrow=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">Bbig2 &lt;-<span class="st"> </span>Bbig</a>
<a class="sourceLine" id="cb3-4" title="4">Bbig2[<span class="dv">1</span>,<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a></code></pre></div>
<p>For the optimizing process, we use code taken from <code>mixOmics::nipals</code> since it avoids <code>for</code> loops over the columns of <span class="math inline">\(\bf X\)</span>, and should have better performance than <code>ade4::nipals</code> or <code>plsdepot::nipals</code>.</p>
<p>The timings are the median of 3 runs. The timings in this section were recorded before the Gram-Schmidt orthogonalization step was added.</p>
<div id="version-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-1" class="anchor"></a>Version 1</h3>
<p>This is the version taken from the <code>mixOmics</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">th =<span class="st"> </span>x0 <span class="op">%*%</span><span class="st"> </span>ph</a>
<a class="sourceLine" id="cb4-2" title="2">P =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>(ph) <span class="op">%o%</span><span class="st"> </span>nr.ones <span class="co"># ph in each column, nr.ones is a vector of 1</span></a>
<a class="sourceLine" id="cb4-3" title="3">P[<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(x.miss)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb4-4" title="4">ph.cross =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(P)</a>
<a class="sourceLine" id="cb4-5" title="5">th =<span class="st"> </span>th <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(ph.cross)</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(res0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#  10.76    0.00   10.78 </span></a></code></pre></div>
</div>
<div id="version-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-2" class="anchor"></a>Version 2</h3>
<p>There’s no need to store the <code>ph.cross</code> object, and the <code><a href="https://rdrr.io/r/base/diag.html">diag(crossprod())</a></code> is needlessly expensive since we only need the diagonal elements. This is an easy change and has a big reward.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">th =<span class="st"> </span>x0 <span class="op">%*%</span><span class="st"> </span>ph</a>
<a class="sourceLine" id="cb5-2" title="2">P =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>(ph) <span class="op">%o%</span><span class="st"> </span>nr.ones <span class="co"># ph in each column</span></a>
<a class="sourceLine" id="cb5-3" title="3">P[<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(x.miss)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb5-4" title="4">th =<span class="st"> </span>th <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(P<span class="op">*</span>P)</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">#    4.4     0.0     4.4</span></a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(res0, res)</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co"># TRUE</span></a></code></pre></div>
</div>
<div id="version-3" class="section level3">
<h3 class="hasAnchor">
<a href="#version-3" class="anchor"></a>Version 3</h3>
<p>Most of the columns of <code>P</code> are the same, so the element-wise multiplication <code>P*P</code> is repeating a lot of the same multiplications in the different columns. Better to square the numbers in one column, then put those into all columns. Also, there’s no need to calculate <code>th</code> in two steps.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">P2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>(ph<span class="op">*</span>ph) <span class="op">%o%</span><span class="st"> </span>nr.ones <span class="co"># ph in each column</span></a>
<a class="sourceLine" id="cb6-2" title="2">P2[<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(x.miss)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb6-3" title="3">th =<span class="st"> </span>x0 <span class="op">%*%</span><span class="st"> </span>ph <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(P2)</a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#      4       0       4 </span></a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(res0, res)</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co"># TRUE</span></a></code></pre></div>
</div>
<div id="version-4" class="section level3">
<h3 class="hasAnchor">
<a href="#version-4" class="anchor"></a>Version 4</h3>
<p>The first line of code is squaring the elements of <code>ph</code>, then outer-multiplying by a vector of 1s to insert these into each column of <code>P2</code>. It makes sense algebraically, but we can avoid the multiplications and just build the matrix <code>P2</code> by recycling the first column.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">P2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(ph<span class="op">*</span>ph, <span class="dt">nrow=</span>nc, <span class="dt">ncol=</span>nr)</a>
<a class="sourceLine" id="cb7-2" title="2">P2[<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(x.miss)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb7-3" title="3">th =<span class="st"> </span>x0 <span class="op">%*%</span><span class="st"> </span>ph <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(P2)</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">#   3.38    0.00    3.41 </span></a>
<a class="sourceLine" id="cb7-8" title="8">   </a>
<a class="sourceLine" id="cb7-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(res0, res)</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="co"># TRUE</span></a></code></pre></div>
</div>
<div id="comments" class="section level3">
<h3 class="hasAnchor">
<a href="#comments" class="anchor"></a>Comments</h3>
<p>Although this look like an easy optimization, there were numerous other (failed) versions, and each version often required fiddling with the syntax to make sure the right results were calculated. For example, what happens if <code>ph</code> is a vector (not a matrix) and is put into a matrix operation? Not always what you might expect.</p>
<p>The optimizations described above reduced the user time from 10.76 seconds to 3.38 seconds.</p>
<p>The total effect of all optimizations in the algorithm reduced the user time for the <code>nipals</code> function from 19.20 seconds to 3.38 seconds in this example.</p>
</div>
</div>
<div id="calculating-pp-and-tt" class="section level1">
<h1 class="hasAnchor">
<a href="#calculating-pp-and-tt" class="anchor"></a>Calculating PP’ and TT’</h1>
<p>In the Gram-Schmidt orthogonalization part of the algorithm, it is necessary to calculate <span class="math inline">\(P_h P_h'\)</span> where <span class="math inline">\(P_h\)</span> is a matrix of the first <span class="math inline">\(h\)</span> columns of the loadings matrix <span class="math inline">\(P\)</span>. It is not necessary to re-calculate the entire <span class="math inline">\(P_h P_h'\)</span> product for each Principal Component, but only to update the product <span class="math inline">\(\bf P_h P_h' = P_{h-1} P_{h-1}' + p_h p_h'\)</span>. Here’s a numerical illustration:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb8-2" title="2">P =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">9</span>), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-3" title="3">PPp =<span class="st"> </span>P <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(P)</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(PPp,</a>
<a class="sourceLine" id="cb8-5" title="5">          P[,<span class="dv">1</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>] <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(P[,<span class="dv">1</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="st">          </span>P[,<span class="dv">2</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>] <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(P[,<span class="dv">2</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>]) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="st">          </span>P[,<span class="dv">3</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>] <span class="op">%*%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(P[,<span class="dv">3</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>]) )</a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co"># TRUE</span></a>
<a class="sourceLine" id="cb8-9" title="9"></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(PPp,</a>
<a class="sourceLine" id="cb8-11" title="11">          <span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod</a></span>(P[,<span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod</a></span>(P[,<span class="dv">2</span>]) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod</a></span>(P[,<span class="dv">3</span>]) )</a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co"># TRUE</span></a>
<a class="sourceLine" id="cb8-13" title="13"></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co"># multiply by a  vector</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>( PPp <span class="op">%*%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb8-16" title="16">           <span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod</a></span>(PPp, <span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)) )</a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co"># TRUE</span></a></code></pre></div>
<p>Using the <span class="math inline">\(100 \times 100\)</span> matrix example, the Gram-Schmidt method adds only a modest increase in time.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(m1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>, <span class="dt">gramschmidt=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">#   3.68    0.02    3.70 </span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(m2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nipals.html">nipals</a></span>(Bbig2, <span class="dt">ncomp=</span><span class="dv">100</span>, <span class="dt">gramschmidt=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">#   user  system elapsed </span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">#   4.29    0.03    4.37 </span></a></code></pre></div>
<div id="r-vs-c-comment" class="section level3">
<h3 class="hasAnchor">
<a href="#r-vs-c-comment" class="anchor"></a>R vs C comment</h3>
<p>The <code><a href="../reference/nipals.html">nipals()</a></code> function makes heavy use of the <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod()</a></code> and <code><a href="https://rdrr.io/r/base/crossprod.html">tcrossprod()</a></code> functions, which are already extensively optimized. Non-optimized coding of the NIPALS algorithm in C would probably be <em>less</em> efficient than the R version used in this package.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#abstract">Abstract</a></li>
      <li><a href="#general-computational-performance-tips">General computational performance tips</a></li>
      <li><a href="#calculating-scores-t-xppp">Calculating scores t = Xp/p’p</a></li>
      <li><a href="#calculating-pp-and-tt">Calculating PP’ and TT’</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin Wright.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
